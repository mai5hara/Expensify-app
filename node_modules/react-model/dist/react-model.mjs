import t from"immer";import{createContext as e,useState as n,useEffect as r,createElement as o,PureComponent as c}from"react";var i={Setter:{classSetter:void 0,functionSetter:{}},State:{},devTools:void 0,withDevTools:!1,uid:Math.random()},a=e({}),s=a.Consumer,u=function(e,n){if(void 0===n&&(n={}),"function"==typeof n){var r=i.State[e].state;r=t(r,n),i.State=t(i.State,function(t){t[e].state=r})}else i.State=t(i.State,function(t){t[e].state=Object.assign({},t[e].state,n)});return i.State},f=function(t){try{return Promise.resolve(Promise.all(Object.keys(i.State).map(function(e){try{var n=function(){if(!t||!t.modelName||e===t.modelName||-1!==t.modelName.indexOf(e)){function n(t){i.State[e].state=Object.assign({},i.State[e].state,t)}var r=i.State[e];return r.asyncState?Promise.resolve(r.asyncState(t)).then(n):n({})}}();return Promise.resolve(n&&n.then?n.then(function(){}):void 0)}catch(t){return Promise.reject(t)}}))).then(function(){return i.State})}catch(t){return Promise.reject(t)}},m=function(t,e){var n=localStorage.getItem("__REACT_MODELX__"+t+"_"+e);return n?JSON.parse(n):null},S=function(t,e){try{return Promise.resolve((0,t.next)(e).catch(function(t){return console.log(t)})).then(function(){})}catch(t){return Promise.reject(t)}},l=function(t,e){try{var n=t.modelName,r=t.params,o=t.next;return Promise.resolve((0,t.action)(i.State[n].state,(0,t.consumerActions)(i.State[n].actions),r)).then(function(n){return t.newState=n,Promise.resolve(o(e)).then(function(){})})}catch(t){return Promise.reject(t)}},v=function(t,e){try{var n=t.modelName,r=t.newState,o=t.next,c=function(){if(r)return u(n,r),Promise.resolve(o(e)).then(function(){})}();return Promise.resolve(c&&c.then?c.then(function(){}):void 0)}catch(t){return Promise.reject(t)}},h=function(t,e){try{var n=t.next;return(0,t.setState)(i.State[t.modelName].state),Promise.resolve(n(e)).then(function(){})}catch(t){return Promise.reject(t)}},d=function(t,e){try{return i.withDevTools&&i.devTools.send(t.modelName+"_"+t.actionName,i.State),Promise.resolve(t.next(e)).then(function(){})}catch(t){return Promise.reject(t)}},p=function(t,e){try{var n=t.modelName,r=t.next,o=t.actionName;return i.Setter.classSetter&&i.Setter.classSetter(i.State),Object.keys(i.Setter.functionSetter[n]).map(function(t){var e=i.Setter.functionSetter[n][t];e&&(e.depActions&&-1===e.depActions.indexOf(o)||e.setState(i.State[n].state))}),Promise.resolve(r(e)).then(function(){})}catch(t){return Promise.reject(t)}},P=[l,v,h,p];P="production"===process.env.NODE_ENV?[S].concat(P):P.concat([d]);var y={tryCatch:S,getNewState:l,getNewStateWithCache:function(t){return void 0===t&&(t=5e3),function(e,n){try{var r=e.modelName,o=e.params,c=e.next,a=e.actionName;return Promise.resolve(Promise.race([(0,e.action)(i.State[r].state,(0,e.consumerActions)(i.State[r].actions),o),(s=t,u=m(r,a),new Promise(function(t){return setTimeout(function(){console.log(s),t(u)},s)}))])).then(function(t){return e.newState=t,Promise.resolve(c(n)).then(function(){})})}catch(t){return Promise.reject(t)}var s,u}},setNewState:v,stateUpdater:h,communicator:p,devToolsListener:d},_=function(t,e){try{e.next=function(t){return t.length>0&&t[0](e,t.slice(1))};var n=function(){if(t.length>0)return Promise.resolve(t[0](e,t.slice(1))).then(function(){})}();return Promise.resolve(n&&n.then?n.then(function(){}):void 0)}catch(t){return Promise.reject(t)}},j=function(t,e){return i.State=e?Object.keys(t).reduce(function(n,r){return n[r]={actions:t[r].actions,state:Object.assign({},t[r].state,e[r].state)},n},{}):Object.assign({},t),i.withDevTools="undefined"!=typeof window&&window.__REDUX_DEVTOOLS_EXTENSION__,i.withDevTools&&(i.devTools=window.__REDUX_DEVTOOLS_EXTENSION__,i.devTools.connect()),{useStore:O,getState:N,getInitialState:f}},N=function(t){return i.State[t].state},O=function(t,e){var o=n(i.State[t].state)[1];i.uid+=1;var c=""+i.uid;i.Setter.functionSetter[t]||(i.Setter.functionSetter[t]={}),i.Setter.functionSetter[t][c]={setState:o,depActions:e},r(function(){return function(){delete i.Setter.functionSetter[t][c]}});var a={},s=function(e){var n={};return Object.keys(e).map(function(r){var c;n[r]=(c=e[r],function(e,n){try{return Promise.resolve(_(P,{modelName:t,setState:o,actionName:c.name,next:function(){},newState:null,params:e,middlewareConfig:n,consumerActions:s,action:c})).then(function(){})}catch(t){return Promise.reject(t)}})}),n};return Object.keys(i.State[t].actions).map(function(e){return a[e]=function(n,r){try{return Promise.resolve(_(P,{modelName:t,setState:o,actionName:e,next:function(){},newState:null,params:n,middlewareConfig:r,consumerActions:s,action:i.State[t].actions[e]})).then(function(){})}catch(t){return Promise.reject(t)}}}),[N(t),a]},w=function(t){function e(){t.apply(this,arguments),this.state=i.State}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype.render=function(){var t=this.props.children;return i.Setter.classSetter=this.setState.bind(this),o(a.Provider,{value:Object.assign({},this.state,{setState:this.setState.bind(this)})},t)},e}(c),g=function(t,e){return function(n){return function(r){function c(){r.apply(this,arguments)}return r&&(c.__proto__=r),(c.prototype=Object.create(r&&r.prototype)).constructor=c,c.prototype.render=function(){return o(s,null,function(r){var c=r[""+t],a=c.state,s=c.actions,f=r.setState,m=function(e){return function(){for(var n=[],r=arguments.length;r--;)n[r]=arguments[r];try{return Promise.resolve(e.apply(void 0,[i.State[t].state,S(s)].concat(n))).then(function(e){e&&(u(t,e),f(i.State),i.Setter.functionSetter[t]&&Object.keys(i.Setter.functionSetter[t]).map(function(e){return i.Setter.functionSetter[t][e]&&i.Setter.functionSetter[t][e].setState(i.State[t].state)}))})}catch(t){return Promise.reject(t)}}},S=function(t){var e={};return Object.keys(t).map(function(n){e[n]=m(t[n])}),e};return o(n,{state:e?e(a):a,actions:S(s)})})},c}(c)}};export{P as actionMiddlewares,j as Model,y as middlewares,w as Provider,s as Consumer,g as connect,N as getState,f as getInitialState};
