!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("immer"),require("react")):"function"==typeof define&&define.amd?define(["exports","immer","react"],e):e(t.reactModel={},t.immer,t.react)}(this,function(t,e,n){e=e&&e.hasOwnProperty("default")?e.default:e;var r={Setter:{classSetter:void 0,functionSetter:{}},State:{},devTools:void 0,withDevTools:!1,uid:Math.random()},o=n.createContext({}),i=o.Consumer,a=function(t,n){if(void 0===n&&(n={}),"function"==typeof n){var o=r.State[t].state;o=e(o,n),r.State=e(r.State,function(e){e[t].state=o})}else r.State=e(r.State,function(e){e[t].state=Object.assign({},e[t].state,n)});return r.State},c=function(t){try{return Promise.resolve(Promise.all(Object.keys(r.State).map(function(e){try{var n=function(){if(!t||!t.modelName||e===t.modelName||-1!==t.modelName.indexOf(e)){function n(t){r.State[e].state=Object.assign({},r.State[e].state,t)}var o=r.State[e];return o.asyncState?Promise.resolve(o.asyncState(t)).then(n):n({})}}();return Promise.resolve(n&&n.then?n.then(function(){}):void 0)}catch(t){return Promise.reject(t)}}))).then(function(){return r.State})}catch(t){return Promise.reject(t)}},s=function(t,e){var n=localStorage.getItem("__REACT_MODELX__"+t+"_"+e);return n?JSON.parse(n):null},u=function(t,e){try{return Promise.resolve((0,t.next)(e).catch(function(t){return console.log(t)})).then(function(){})}catch(t){return Promise.reject(t)}},f=function(t,e){try{var n=t.modelName,o=t.params,i=t.next;return Promise.resolve((0,t.action)(r.State[n].state,(0,t.consumerActions)(r.State[n].actions),o)).then(function(n){return t.newState=n,Promise.resolve(i(e)).then(function(){})})}catch(t){return Promise.reject(t)}},m=function(t,e){try{var n=t.modelName,r=t.newState,o=t.next,i=function(){if(r)return a(n,r),Promise.resolve(o(e)).then(function(){})}();return Promise.resolve(i&&i.then?i.then(function(){}):void 0)}catch(t){return Promise.reject(t)}},S=function(t,e){try{var n=t.next;return(0,t.setState)(r.State[t.modelName].state),Promise.resolve(n(e)).then(function(){})}catch(t){return Promise.reject(t)}},l=function(t,e){try{return r.withDevTools&&r.devTools.send(t.modelName+"_"+t.actionName,r.State),Promise.resolve(t.next(e)).then(function(){})}catch(t){return Promise.reject(t)}},d=function(t,e){try{var n=t.modelName,o=t.next,i=t.actionName;return r.Setter.classSetter&&r.Setter.classSetter(r.State),Object.keys(r.Setter.functionSetter[n]).map(function(t){var e=r.Setter.functionSetter[n][t];e&&(e.depActions&&-1===e.depActions.indexOf(i)||e.setState(r.State[n].state))}),Promise.resolve(o(e)).then(function(){})}catch(t){return Promise.reject(t)}};t.actionMiddlewares=[f,m,S,d],t.actionMiddlewares="production"===process.env.NODE_ENV?[u].concat(t.actionMiddlewares):t.actionMiddlewares.concat([l]);var v={tryCatch:u,getNewState:f,getNewStateWithCache:function(t){return void 0===t&&(t=5e3),function(e,n){try{var o=e.modelName,i=e.params,a=e.next,c=e.actionName;return Promise.resolve(Promise.race([(0,e.action)(r.State[o].state,(0,e.consumerActions)(r.State[o].actions),i),(u=t,f=s(o,c),new Promise(function(t){return setTimeout(function(){console.log(u),t(f)},u)}))])).then(function(t){return e.newState=t,Promise.resolve(a(n)).then(function(){})})}catch(t){return Promise.reject(t)}var u,f}},setNewState:m,stateUpdater:S,communicator:d,devToolsListener:l},h=function(t,e){try{e.next=function(t){return t.length>0&&t[0](e,t.slice(1))};var n=function(){if(t.length>0)return Promise.resolve(t[0](e,t.slice(1))).then(function(){})}();return Promise.resolve(n&&n.then?n.then(function(){}):void 0)}catch(t){return Promise.reject(t)}},p=function(t){return r.State[t].state},P=function(e,o){var i=n.useState(r.State[e].state)[1];r.uid+=1;var a=""+r.uid;r.Setter.functionSetter[e]||(r.Setter.functionSetter[e]={}),r.Setter.functionSetter[e][a]={setState:i,depActions:o},n.useEffect(function(){return function(){delete r.Setter.functionSetter[e][a]}});var c={},s=function(n){var r={};return Object.keys(n).map(function(o){var a;r[o]=(a=n[o],function(n,r){try{return Promise.resolve(h(t.actionMiddlewares,{modelName:e,setState:i,actionName:a.name,next:function(){},newState:null,params:n,middlewareConfig:r,consumerActions:s,action:a})).then(function(){})}catch(t){return Promise.reject(t)}})}),r};return Object.keys(r.State[e].actions).map(function(n){return c[n]=function(o,a){try{return Promise.resolve(h(t.actionMiddlewares,{modelName:e,setState:i,actionName:n,next:function(){},newState:null,params:o,middlewareConfig:a,consumerActions:s,action:r.State[e].actions[n]})).then(function(){})}catch(t){return Promise.reject(t)}}}),[p(e),c]},y=function(t){function e(){t.apply(this,arguments),this.state=r.State}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype.render=function(){var t=this.props.children;return r.Setter.classSetter=this.setState.bind(this),n.createElement(o.Provider,{value:Object.assign({},this.state,{setState:this.setState.bind(this)})},t)},e}(n.PureComponent);t.Model=function(t,e){return r.State=e?Object.keys(t).reduce(function(n,r){return n[r]={actions:t[r].actions,state:Object.assign({},t[r].state,e[r].state)},n},{}):Object.assign({},t),r.withDevTools="undefined"!=typeof window&&window.__REDUX_DEVTOOLS_EXTENSION__,r.withDevTools&&(r.devTools=window.__REDUX_DEVTOOLS_EXTENSION__,r.devTools.connect()),{useStore:P,getState:p,getInitialState:c}},t.middlewares=v,t.Provider=y,t.Consumer=i,t.connect=function(t,e){return function(o){return function(c){function s(){c.apply(this,arguments)}return c&&(s.__proto__=c),(s.prototype=Object.create(c&&c.prototype)).constructor=s,s.prototype.render=function(){return n.createElement(i,null,function(i){var c=i[""+t],s=c.state,u=c.actions,f=i.setState,m=function(e){return function(){for(var n=[],o=arguments.length;o--;)n[o]=arguments[o];try{return Promise.resolve(e.apply(void 0,[r.State[t].state,S(u)].concat(n))).then(function(e){e&&(a(t,e),f(r.State),r.Setter.functionSetter[t]&&Object.keys(r.Setter.functionSetter[t]).map(function(e){return r.Setter.functionSetter[t][e]&&r.Setter.functionSetter[t][e].setState(r.State[t].state)}))})}catch(t){return Promise.reject(t)}}},S=function(t){var e={};return Object.keys(t).map(function(n){e[n]=m(t[n])}),e};return n.createElement(o,{state:e?e(s):s,actions:S(u)})})},s}(n.PureComponent)}},t.getState=p,t.getInitialState=c});
