var t,e=(t=require("immer"))&&"object"==typeof t&&"default"in t?t.default:t,n=require("react"),r={Setter:{classSetter:void 0,functionSetter:{}},State:{},devTools:void 0,withDevTools:!1,uid:Math.random()},o=n.createContext({}),a=o.Consumer,i=function(t,n){if(void 0===n&&(n={}),"function"==typeof n){var o=r.State[t].state;o=e(o,n),r.State=e(r.State,function(e){e[t].state=o})}else r.State=e(r.State,function(e){e[t].state=Object.assign({},e[t].state,n)});return r.State},c=function(t){try{return Promise.resolve(Promise.all(Object.keys(r.State).map(function(e){try{var n=function(){if(!t||!t.modelName||e===t.modelName||-1!==t.modelName.indexOf(e)){function n(t){r.State[e].state=Object.assign({},r.State[e].state,t)}var o=r.State[e];return o.asyncState?Promise.resolve(o.asyncState(t)).then(n):n({})}}();return Promise.resolve(n&&n.then?n.then(function(){}):void 0)}catch(t){return Promise.reject(t)}}))).then(function(){return r.State})}catch(t){return Promise.reject(t)}},s=function(t,e){var n=localStorage.getItem("__REACT_MODELX__"+t+"_"+e);return n?JSON.parse(n):null},u=function(t,e){try{return Promise.resolve((0,t.next)(e).catch(function(t){return console.log(t)})).then(function(){})}catch(t){return Promise.reject(t)}},f=function(t,e){try{var n=t.modelName,o=t.params,a=t.next;return Promise.resolve((0,t.action)(r.State[n].state,(0,t.consumerActions)(r.State[n].actions),o)).then(function(n){return t.newState=n,Promise.resolve(a(e)).then(function(){})})}catch(t){return Promise.reject(t)}},m=function(t,e){try{var n=t.modelName,r=t.newState,o=t.next,a=function(){if(r)return i(n,r),Promise.resolve(o(e)).then(function(){})}();return Promise.resolve(a&&a.then?a.then(function(){}):void 0)}catch(t){return Promise.reject(t)}},S=function(t,e){try{var n=t.next;return(0,t.setState)(r.State[t.modelName].state),Promise.resolve(n(e)).then(function(){})}catch(t){return Promise.reject(t)}},l=function(t,e){try{return r.withDevTools&&r.devTools.send(t.modelName+"_"+t.actionName,r.State),Promise.resolve(t.next(e)).then(function(){})}catch(t){return Promise.reject(t)}},d=function(t,e){try{var n=t.modelName,o=t.next,a=t.actionName;return r.Setter.classSetter&&r.Setter.classSetter(r.State),Object.keys(r.Setter.functionSetter[n]).map(function(t){var e=r.Setter.functionSetter[n][t];e&&(e.depActions&&-1===e.depActions.indexOf(a)||e.setState(r.State[n].state))}),Promise.resolve(o(e)).then(function(){})}catch(t){return Promise.reject(t)}};exports.actionMiddlewares=[f,m,S,d],"production"===process.env.NODE_ENV?exports.actionMiddlewares=[u].concat(exports.actionMiddlewares):exports.actionMiddlewares=exports.actionMiddlewares.concat([l]);var v={tryCatch:u,getNewState:f,getNewStateWithCache:function(t){return void 0===t&&(t=5e3),function(e,n){try{var o=e.modelName,a=e.params,i=e.next,c=e.actionName;return Promise.resolve(Promise.race([(0,e.action)(r.State[o].state,(0,e.consumerActions)(r.State[o].actions),a),(u=t,f=s(o,c),new Promise(function(t){return setTimeout(function(){console.log(u),t(f)},u)}))])).then(function(t){return e.newState=t,Promise.resolve(i(n)).then(function(){})})}catch(t){return Promise.reject(t)}var u,f}},setNewState:m,stateUpdater:S,communicator:d,devToolsListener:l},p=function(t,e){try{e.next=function(t){return t.length>0&&t[0](e,t.slice(1))};var n=function(){if(t.length>0)return Promise.resolve(t[0](e,t.slice(1))).then(function(){})}();return Promise.resolve(n&&n.then?n.then(function(){}):void 0)}catch(t){return Promise.reject(t)}},h=function(t){return r.State[t].state},P=function(t,e){var o=n.useState(r.State[t].state)[1];r.uid+=1;var a=""+r.uid;r.Setter.functionSetter[t]||(r.Setter.functionSetter[t]={}),r.Setter.functionSetter[t][a]={setState:o,depActions:e},n.useEffect(function(){return function(){delete r.Setter.functionSetter[t][a]}});var i={},c=function(e){var n={};return Object.keys(e).map(function(r){var a;n[r]=(a=e[r],function(e,n){try{return Promise.resolve(p(exports.actionMiddlewares,{modelName:t,setState:o,actionName:a.name,next:function(){},newState:null,params:e,middlewareConfig:n,consumerActions:c,action:a})).then(function(){})}catch(t){return Promise.reject(t)}})}),n};return Object.keys(r.State[t].actions).map(function(e){return i[e]=function(n,a){try{return Promise.resolve(p(exports.actionMiddlewares,{modelName:t,setState:o,actionName:e,next:function(){},newState:null,params:n,middlewareConfig:a,consumerActions:c,action:r.State[t].actions[e]})).then(function(){})}catch(t){return Promise.reject(t)}}}),[h(t),i]},y=function(t){function e(){t.apply(this,arguments),this.state=r.State}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype.render=function(){var t=this.props.children;return r.Setter.classSetter=this.setState.bind(this),n.createElement(o.Provider,{value:Object.assign({},this.state,{setState:this.setState.bind(this)})},t)},e}(n.PureComponent);exports.Model=function(t,e){return r.State=e?Object.keys(t).reduce(function(n,r){return n[r]={actions:t[r].actions,state:Object.assign({},t[r].state,e[r].state)},n},{}):Object.assign({},t),r.withDevTools="undefined"!=typeof window&&window.__REDUX_DEVTOOLS_EXTENSION__,r.withDevTools&&(r.devTools=window.__REDUX_DEVTOOLS_EXTENSION__,r.devTools.connect()),{useStore:P,getState:h,getInitialState:c}},exports.middlewares=v,exports.Provider=y,exports.Consumer=a,exports.connect=function(t,e){return function(o){return function(c){function s(){c.apply(this,arguments)}return c&&(s.__proto__=c),(s.prototype=Object.create(c&&c.prototype)).constructor=s,s.prototype.render=function(){return n.createElement(a,null,function(a){var c=a[""+t],s=c.state,u=c.actions,f=a.setState,m=function(e){return function(){for(var n=[],o=arguments.length;o--;)n[o]=arguments[o];try{return Promise.resolve(e.apply(void 0,[r.State[t].state,S(u)].concat(n))).then(function(e){e&&(i(t,e),f(r.State),r.Setter.functionSetter[t]&&Object.keys(r.Setter.functionSetter[t]).map(function(e){return r.Setter.functionSetter[t][e]&&r.Setter.functionSetter[t][e].setState(r.State[t].state)}))})}catch(t){return Promise.reject(t)}}},S=function(t){var e={};return Object.keys(t).map(function(n){e[n]=m(t[n])}),e};return n.createElement(o,{state:e?e(s):s,actions:S(u)})})},s}(n.PureComponent)}},exports.getState=h,exports.getInitialState=c;
